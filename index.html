<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ligue Warzone — Classement & Calendrier</title>
  <meta name="description" content="Classement, journées (Masters Kills) et calendrier de la Ligue Warzone."/>
  <style>
    :root{ --bg:#0f1115; --card:#151924; --muted:#8b98a5; --text:#e7edf3; --border:#202636; --bad:#ef4444; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#0b0f14;color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    header{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:12px}
    .title h1{margin:0;font-size:22px}
    .title p{margin:4px 0 0;color:var(--muted);font-size:13px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--border);background:#111622;color:#d8e7ff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .tab.active,.tab:hover{outline:2px solid rgba(109,211,255,.25)}
    .card{background:#121826;border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:14px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .pill{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0f1421;color:#cfe6ff}
    .btn{cursor:pointer;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#141b24;color:#e8eef5}
    .input{background:#0c0f16;border:1px solid var(--border);padding:8px 10px;border-radius:10px;color:var(--text)}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:10px;text-align:left}
    th{color:#b9c6d1;font-size:12px;letter-spacing:.5px;text-transform:uppercase}
    tbody tr{background:#0f1421;border:1px solid var(--border)}
    tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    .rank{width:36px;text-align:center;font-weight:800}
    .badge{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:#233042;color:#e7edf3;font-weight:800}
    /* calendrier */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .event{border:1px solid var(--border);background:#0f1421;border-radius:14px;padding:12px}
    .event.played .title{ text-decoration: line-through; text-decoration-color: var(--bad); text-decoration-thickness: 2px; color:var(--bad) }
    .muted{color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>Ligue Warzone</h1>
      <p>Classement, journées & calendrier</p>
    </div>
    <nav class="tabs" role="tablist" aria-label="Navigation">
      <button class="tab active" data-tab="standings">Classement</button>
      <button class="tab" data-tab="calendar">Calendrier</button>
    </nav>
  </header>

  <!-- CLASSEMENT -->
  <section id="standings" class="card" role="tabpanel">
    <div class="toolbar">
      <input id="search" class="input" placeholder="Rechercher un joueur…" />
      <span id="season" class="pill">Saison —</span>
      <span id="updated" class="pill">Dernière mise à jour —</span>
    </div>
    <table aria-label="Classement">
      <thead>
        <tr><th>#</th><th>Joueur</th><th>MJ</th><th>Kills</th><th>Bonus</th><th>Pts</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>

  <!-- CALENDRIER -->
  <section id="calendar" class="card" role="tabpanel" hidden>
    <div class="toolbar">
      <button id="togglePlayed" class="btn">Basculer “jouée” (saisie rapide)</button>
    </div>
    <div id="calwrap" class="grid"></div>
    <p class="muted" style="margin-top:8px">Les journées <strong>jouées</strong> sont <span style="color:#ef4444">rouges</span> et <span style="text-decoration:line-through;color:#ef4444">barrées</span>.</p>
  </section>
</div>

<script>
/* ---------- SOURCES DE DONNÉES ---------- */
const STANDINGS_URL = "./warzone.json";
const CALENDAR_URL  = "./calendar_warzone.json";

/* ---------- UTILS ---------- */
const asInt = v => Number.parseInt(v,10) || 0;
const byId  = id => document.getElementById(id);
const fmt   = iso => { const d=new Date(iso); return isNaN(d)? "—" : d.toLocaleString('fr-FR',{dateStyle:'medium', timeStyle:'short'}) };

/* ---------- ÉTAT ---------- */
let state = { season: 1, updatedAt: new Date().toISOString(), players: [], journees: [], calendar: [] };

/* ---------- CLASSEMENT (Pts = kills + bonus) ---------- */
function computeStandings(){
  const table = new Map(
    (state.players || []).map(p => [
      p.id,
      { id:p.id, name:p.name, color:p.color||'#233042', MJ:0, KILLS:0, BONUS:0, PTS:0 }
    ])
  );
  const bonusMap = {1:60,2:40,3:20,4:10};
  for (const j of (state.journees || [])) {
    for (const e of (j.entries || [])) {
      const row = table.get(e.player);
      if (!row) continue;
      row.MJ += 1;
      const kills = asInt(e.kills);
      const bonus = Number.isFinite(Number(e.bonus))
        ? asInt(e.bonus)
        : (bonusMap[asInt(e.rank)] || 0);
      const pts = kills + bonus; // règle fixée
      row.KILLS += kills; row.BONUS += bonus; row.PTS += pts;
    }
  }
  return Array.from(table.values())
    .sort((a,b)=> (b.PTS-a.PTS) || (b.KILLS-a.KILLS) || (b.BONUS-a.BONUS) || a.name.localeCompare(b.name));
}

function renderStandings(){
  const q = byId('search').value.toLowerCase();
  const rows = computeStandings().filter(r => r.name.toLowerCase().includes(q));
  byId('tbody').innerHTML = rows.map((r,i)=>`
    <tr>
      <td class="rank">${i+1}</td>
      <td><div style="display:flex;align-items:center;gap:10px"><div class="badge">${r.id}</div><strong>${r.name}</strong></div></td>
      <td>${r.MJ}</td><td>${r.KILLS}</td><td>${r.BONUS}</td><td><strong>${r.PTS}</strong></td>
    </tr>`).join("");
  byId('season').textContent  = 'Saison ' + (state.season||'—');
  byId('updated').textContent = 'Dernière mise à jour — ' + fmt(state.updatedAt);
}

/* ---------- CALENDRIER ---------- */
function renderCalendar(){
  const wrap = byId('calwrap');
  if(!state.calendar?.length){ wrap.innerHTML = '<div class="muted">Aucune journée.</div>'; return; }
  const days = [...state.calendar].sort((a,b)=> a.journee - b.journee);
  wrap.innerHTML = days.map(d => `
    <div class="event ${d.played ? 'played' : ''}" data-j="${d.journee}">
      <div class="title"><strong>Journée ${d.journee}</strong></div>
      <div class="muted">Exemptés : ${d.exemptes.join(', ')||'—'}</div>
      <div style="margin-top:6px">${d.matches.map(m => `• ${m.join(', ')}`).join('<br/>')}</div>
      <div class="muted" style="margin-top:6px">${d.played ? 'Jouée' : 'À jouer'}</div>
    </div>
  `).join('');
  wrap.querySelectorAll('.event').forEach(card=>{
    card.addEventListener('click', () => {
      const j = Number(card.getAttribute('data-j'));
      const d = state.calendar.find(x => x.journee === j);
      if(!d) return;
      d.played = !d.played;
      renderCalendar();
      alert(`Journée ${j} marquée ${d.played ? 'jouée' : 'non jouée'} (modifie calendar_warzone.json pour sauvegarder).`);
    });
  });
}

/* ---------- INIT ---------- */
async function boot(){
  try{
    const [standingsRes, calRes] = await Promise.all([
      fetch(STANDINGS_URL, {cache:'no-store'}),
      fetch(CALENDAR_URL,  {cache:'no-store'})
    ]);
    const standings = await standingsRes.json();
    const cal = await calRes.json();
    state.season   = standings.season || 1;
    state.updatedAt= new Date().toISOString();
    state.players  = standings.players || [];
    state.journees = standings.journees || [];
    state.calendar = cal.calendar || [];
    renderStandings();
    renderCalendar();
  }catch(e){
    console.error(e);
    byId('tbody').innerHTML = '<tr><td colspan="6">Erreur de chargement des données.</td></tr>';
  }
}

/* ---------- UI ---------- */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const id = btn.getAttribute('data-tab');
    document.querySelectorAll('section[role="tabpanel"]').forEach(s=> s.hidden = (s.id!==id));
  });
});
byId('search').addEventListener('input', renderStandings);
byId('togglePlayed').addEventListener('click', ()=>{
  const j = Number(prompt('Numéro de journée à basculer ?'));
  const d = state.calendar.find(x => x.journee===j);
  if(!d) return;
  d.played = !d.played;
  renderCalendar();
});

/* ---------- GO ---------- */
boot();
</script>
</body>
</html>
